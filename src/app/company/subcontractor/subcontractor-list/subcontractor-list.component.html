<div class="container mt-4">
  <div class="card">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Liste des Sous-traitants</h5>
      <button class="btn btn-light" (click)="navigateToCreate()" title="Ajouter un Sous-traitant">
        <i class="fas fa-plus"></i>
      </button>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive-sm">
        <table class="table table-hover table-striped mb-0">
          <thead class="bg-light">
            <tr>
              <th class="py-3 d-none d-md-table-cell">ID</th>
              <th class="py-3">Entreprise</th>
              <th class="py-3 d-none d-md-table-cell">Expertise</th>
              <th class="py-3 d-none d-lg-table-cell">Location</th>
              <th class="py-3 d-none d-lg-table-cell">Phone</th>
              <th class="py-3">Statut</th>
              <th class="py-3 text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let contractor of subcontractors">
              <td class="align-middle d-none d-md-table-cell">{{contractor.id}}</td>
              <td class="align-middle">{{contractor.company}}</td>
              <td class="align-middle d-none d-md-table-cell">{{contractor.expertise}}</td>
              <td class="align-middle d-none d-lg-table-cell">{{contractor.location}}</td>
              <td class="align-middle d-none d-lg-table-cell">{{contractor.phone}}</td>
              <td class="align-middle">
                <button class="btn btn-sm ms-2" 
                  [ngClass]="{'btn-danger': contractor.status === 'inactive', 'btn-success': contractor.status === 'active'}"
                  (click)="confirmStatusChange(contractor)"
                  [disabled]="loading">
                  <i class="fas" [ngClass]="{'fa-ban': contractor.status === 'inactive', 'fa-check': contractor.status === 'active'}"></i>
                  {{contractor.status === 'inactive' ? 'Désactiver' : 'Activer'}}
                </button>
              </td>
              <td class="align-middle">
                <div class="d-flex justify-content-end gap-2">
                  <!-- View Profile Button -->
                  <button class="btn btn-sm btn-info" (click)="navigateToProfile(contractor.id)" title="Voir le profil">
                    <i class="fas fa-user"></i>
                  </button>
                  <!-- Edit Button -->
                  <button class="btn btn-sm btn-primary" (click)="navigateToEdit(contractor.id)" title="Modifier">
                    <i class="fas fa-edit"></i>
                  </button>
                  <!-- Archive Button -->
                  <button class="btn btn-sm btn-danger" (click)="confirmArchive(contractor.id)" title="Archiver">
                    <i class="fas fa-archive"></i>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="subcontractors.length === 0">
              <td colspan="7" class="text-center py-4">Aucun sous-traitant trouvé</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="d-flex justify-content-center mt-3">
      <nav aria-label="Page navigation example">
        <ul class="pagination">
          <li class="page-item">
            <a
              (click)="goToFirstPage()"
              class="page-link"
              href="javascript:void(0)"
              aria-label="Previous"
              [class.disabled]="page === 0"
            >
              <i class="fa-solid fa-angles-left"></i>
            </a>
          </li>
          <li class="page-item">
            <a
              (click)="goToPreviousPage()"
              class="page-link"
              href="javascript:void(0)"
              aria-label="Previous"
              [class.disabled]="page === 0"
            >
              <i class="fa-solid fa-angle-left"></i>
            </a>
          </li>
          <li
            class="page-item"
            *ngFor="let pageIndex of pages"
          >
            <a
              (click)="gotToPage(pageIndex)"
              class="page-link"
              [class.active]="page === pageIndex"
              href="javascript:void(0)"
            >{{ pageIndex + 1 }}</a>
          </li>
          <li class="page-item">
            <a
              (click)="goToNextPage()"
              class="page-link"
              href="javascript:void(0)"
              aria-label="Next"
              [class.disabled]="isLastPage"
            >
              <i class="fa-solid fa-chevron-right"></i>
            </a>
          </li>
          <li class="page-item">
            <a
              (click)="goToLastPage()"
              class="page-link"
              href="javascript:void(0)"
              aria-label="Next"
              [class.disabled]="isLastPage"
            >
              <i class="fa-solid fa-angles-right"></i>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!--  create subcontractor modal -->
<div class="modal fade" id="createSubcontractorModal" tabindex="-1" aria-labelledby="createSubcontractorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="createSubcontractorModalLabel">
          <i class="fas fa-plus me-2"></i>
          Ajouter un Sous-traitant
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form #subcontractorForm="ngForm">
          <div class="mb-3">
            <label for="profilePicture" class="form-label">Photo de profil</label>
            <div class="d-flex align-items-center gap-3">
              <img [src]="newSubcontractor.profilePicture || 'assets/images/default-company.png'" class="rounded-circle"
                style="width: 100px; height: 100px; object-fit: cover;" alt="Profile picture">
              <div class="flex-grow-1">
                <input type="file" class="form-control" id="profilePicture" accept="image/*"
                  (change)="onFileSelected($event)">
                <small class="text-muted">Taille maximale: 5MB</small>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-md-6">
              <label for="company" class="form-label">Entreprise*</label>
              <input type="text" class="form-control" id="company" name="company" [(ngModel)]="newSubcontractor.company"
                required>
            </div>
            <div class="mb-3 col-md-6">
              <label for="workSector" class="form-label">Secteur d'activité*</label>
              <input type="text" class="form-control" id="workSector" name="workSector"
                [(ngModel)]="newSubcontractor.workSector" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="location" class="form-label">Adresse*</label>
            <input type="text" class="form-control" id="location" name="location"
              [(ngModel)]="newSubcontractor.address.street" required>
          </div>
          <div class="row">
            <div class="mb-3 col-md-6">
              <label for="postalCode" class="form-label">Code postal*</label>
              <input type="text" class="form-control" id="postalCode" name="postalCode"
                [(ngModel)]="newSubcontractor.address.zip" required>
            </div>
            <div class="mb-3 col-md-6">
              <label for="city" class="form-label">Ville*</label>
              <input type="text" class="form-control" id="city" name="city" [(ngModel)]="newSubcontractor.address.city"
                required>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-md-6">
              <label for="phone" class="form-label">Téléphone*</label>
              <input type="tel" class="form-control" id="phone" name="phone" [(ngModel)]="newSubcontractor.phone"
                required>
            </div>
            <div class="mb-3 col-md-6">
              <label for="email" class="form-label">Email*</label>
              <input type="email" class="form-control" id="email" name="email" [(ngModel)]="newSubcontractor.email"
                required>
            </div>
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description"
              [(ngModel)]="newSubcontractor.description" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <!-- Reset Button -->
        <button type="button" class="btn btn-secondary" (click)="resetForm()">
          <i class="fa fa-rotate-left"></i> Réinitialiser
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="!subcontractorForm.form.valid || loading"
          (click)="saveSubcontractor()">
          <span class="spinner-border spinner-border-sm me-1" *ngIf="loading"></span>
          Créer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Status Change Confirmation Modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"
        [ngClass]="{'bg-danger text-white': selectedContractor?.status === 'active', 'bg-success text-white': selectedContractor?.status === 'inactive'}">
        <h5 class="modal-title" id="statusChangeModalLabel">Confirmation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p *ngIf="selectedContractor?.status === 'active'">
          Êtes-vous sûr de vouloir désactiver le compte de <strong>{{selectedContractor?.company}}</strong> ?<br>
          Cette action limitera l'accès du sous-traitant à la plateforme.
        </p>
        <p *ngIf="selectedContractor?.status === 'inactive'">
          Voulez-vous réactiver le compte de <strong>{{selectedContractor?.company}}</strong> ?
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button"
          [ngClass]="{'btn-danger': selectedContractor?.status === 'active', 'btn-success': selectedContractor?.status === 'inactive'}"
          class="btn" (click)="toggleStatus()" [disabled]="loading">
          {{selectedContractor?.status === 'active' ? 'Désactiver' : 'Activer'}}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Archive Confirmation Modal -->
<div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="archiveModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Confirmation d'archivage
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-circle me-2"></i>
          <strong>Attention :</strong> L'archivage du compte entraînera automatiquement sa désactivation.
        </div>
        <p>Êtes-vous sûr de vouloir archiver le compte de l'entreprise <strong>{{selectedContractor?.company}}</strong>
          ?</p>
        <p class="text-muted">Cette action peut être annulée ultérieurement.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>Annuler
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmArchiveAction()" [disabled]="loading">
          <i class="fas fa-archive me-2"></i>Archiver
          <span class="spinner-border spinner-border-sm ms-1" *ngIf="loading"></span>
        </button>
      </div>
    </div>
  </div>
</div>